@{
    Layout = "~/Views/Shared/_mytemplate.cshtml";
    ViewBag.Title = "Chat";
}

<link href="~/Content/chat.css" rel="stylesheet" />
<link href="~/Content/themes/base/jquery-ui.css" rel="stylesheet" />  
<style>
    .btn {
        -webkit-border-radius: 28;
        -moz-border-radius: 28;
    
        font-family: Arial;
        color: #ffffff;
        font-size: 12px;
        background: #f5a039;
       
        text-decoration: none;
    }

 
    .btn:hover {
        background: #93cc72;
        text-decoration: none;
    }
</style>


<div style="margin-left:30px;font-family: raleway-regular, arial; letter-spacing: 1px;">
    <h2>Chat</h2>

    <div id="container">
        <input type="hidden" id="nickname" />
        <div id="chatlog"></div>
        <div id="onlineusers">
            <b>Online Users</b>
        </div>
        <div id="chatarea">
            <div class="messagelog">
                <textarea spellcheck="true" id="message" class="messagebox"></textarea>
            </div>
            <div class="actionpane">
                <input class="btn" style="width:80px;height:35px;margin:20px;" type="button" id="btnsend" value="Send" />
                <select id="users" style="width:70px;margin-top:20px;">
                    <option value="All">All</option>
                </select>
            </div>
            <div class="actionpane">

            </div>
        </div>
        <div id="dialog" title="Enter your name to start a chat.">
            <input type="text" id="nick" />
        </div>
    </div>

    </div>

    @*<div class="container">
            <input type="text" id="message" />
            <input type="button" id="sendmessage" value="Send" />
            <input type="hidden" id="displayname" />
            <ul id="discussion"></ul>
        </div>*@


    @*@section scripts {
            <!--Script references. -->
            <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
            <!--Reference the SignalR library. -->
            <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
            <!--Reference the autogenerated SignalR hub script. -->
            <script src="~/signalr/hubs"></script>
            <!--SignalR script to update the chat page and send messages.-->
            <script>
                $(function () {
                    // Reference the auto-generated proxy for the hub.
                    var chat = $.connection.chatHub;
                    // Create a function that the hub can call back to display messages.
                    chat.client.addNewMessageToPage = function (name, message) {
                        // Add the message to the page.
                        $('#discussion').append('<li><strong>' + htmlEncode(name)
                            + '</strong>: ' + htmlEncode(message) + '</li>');
                    };
                    // Get the user name and store it to prepend to messages.
                    $('#displayname').val(prompt('Enter your name:', ''));
                    // Set initial focus to message input box.
                    $('#message').focus();
                    // Start the connection.
                    $.connection.hub.start().done(function () {
                        $('#sendmessage').click(function () {
                            // Call the Send method on the hub.
                            chat.server.send($('#displayname').val(), $('#message').val());
                            // Clear text box and reset focus for next comment.
                            $('#message').val('').focus();
                        });
                    });
                });
                // This optional function html-encodes messages for display in the page.
                function htmlEncode(value) {
                    var encodedValue = $('<div />').text(value).html();
                    return encodedValue;
                }
            </script>
        }*@




        <script src="~/Scripts/jquery-ui-1.9.2.min.js"></script>
        <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
        <script src="~/signalr/hubs"></script>

        <script type="text/javascript">


            $(function () {
                showModalUserNickName();
            });

            function showModalUserNickName() {
                $("#dialog").dialog({
                    modal: true,
                    buttons: {
                        Ok: function () {
                            $(this).dialog("close");
                            startChatHub();
                        }
                    }
                });
            }

            function startChatHub() {
                var chat = $.connection.chatHub;

                // Get the user name.
                $('#nickname').val($('#nick').val());
                chat.client.differentName = function (name) {
                    showModalUserNickName();
                    return false;
                    // Prompts for different user name
                    $('#nickname').val($('#nick').val());
                    chat.server.notify($('#nickname').val(), $.connection.hub.id);
                };

                chat.client.online = function (name) {
                    // Update list of users
                    if (name == $('#nickname').val())
                        $('#onlineusers').append('<div class="border" style="color:green">You: ' + name + '</div>');
                    else {
                        $('#onlineusers').append('<div class="border">' + name + '</div>');
                        $("#users").append('<option value="' + name + '">' + name + '</option>');
                    }
                };

                chat.client.enters = function (name) {
                    $('#chatlog').append('<div ><i>' + name + ' joins the conversation</i></div>');
                    $("#users").append('<option value="' + name + '">' + name + '</option>');
                    $('#onlineusers').append('<div class="border">' + name + '</div>');
                };
                // Create a function that the hub can call to broadcast chat messages.
                chat.client.broadcastMessage = function (name, message) {
                    //Interpret smileys
                    message = message.replace(":)", "<img src=\"/images/smile.png\" class=\"smileys\" />");
                    message = message.replace(":x", "<img src=\"/images/shut.png\" class=\"smileys\" />");
                    message = message.replace("cool", "<img src=\"/images/gg.png\" class=\"smileys\" />");
                    message = message.replace(":d", "<img src=\"/images/dd.png\" class=\"smileys\" />");
                    message = message.replace("hi", "<img src=\"/images/hi.png\" class=\"smileys\" />");
                    message = message.replace(":p", "<img src=\"/images/tongue.png\" class=\"smileys\" />");
                    message = message.replace(":(", "<img src=\"/images/sad.png\" class=\"smileys\" />");
                    message = message.replace("good", "<img src=\"/images/good.png\" class=\"smileys\" />");



                    //display the message
                    $('#chatlog').append('<div class="border"><span style="color:orange">' + name + '</span>: ' + message + '</div>');
                };

                //chat.client.disconnected = function (name) {
                //    //Calls when someone leaves the page
                //    $('#chatlog').append('<div ><i>' + name + ' leaves the conversation</i></div>');
                //    $('#onlineusers div').remove(":contains('" + name + "')");
                //    $("#users option").remove(":contains('" + name + "')");
                //}

                // Start the connection.
                $.connection.hub.start().done(function () {
                    //Calls the notify method of the server
                    chat.server.notify($('#nickname').val(), $.connection.hub.id);

                    $('#btnsend').click(function () {
                        if ($("#users").val() == "All") {
                            // Call the Send method on the hub.
                            chat.server.send($('#nickname').val(), $('#message').val());
                        }
                        else {
                            chat.server.sendToSpecific($('#nickname').val(), $('#message').val(), $("#users").val());
                        }
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    });

                });
            }

        </script>
    
